# study_oml
> [OML](https://open-metric-learning.readthedocs.io/en/latest/index.html)

>> [Training](https://colab.research.google.com/drive/1kntDAIdIZ9L40jcndguLAb-XqmCFOgS5?usp=sharing)
```
dataset_root = "mock_dataset/"
df_train, _ = download_mock_dataset(dataset_root)
df_train.head()
```
![image](https://github.com/Suyeon-j/study_oml/assets/66247203/ae6c2e91-b44a-469c-bd63-32bcecc8456d)
>>> 구조 (8x3)


![image](https://github.com/Suyeon-j/study_oml/assets/66247203/ba0849ad-4d36-42db-96ad-615fea39551f)


```
# https://open-metric-learning.readthedocs.io/en/latest/contents/models.html#vitextractor
# 03
model = ViTExtractor("vits16_dino", arch="vits16", normalise_features=False).train()
model
```
ViTExtractor(weights(사전 훈련된 가중치 지정 매개변수), arch(모델 아키텍처 선택), normalise_features(특성 정규화 여부)): [Visual Transformer 아키텍처](https://gaussian37.github.io/dl-concept-vit/)를 따르는 추출기의 기본 클래스
![image](https://github.com/Suyeon-j/study_oml/assets/66247203/99d36ddd-809c-4933-93ef-530d90d028e3)

```
# https://pytorch.org/docs/stable/generated/torch.optim.SGD.html
# 05
optimizer = torch.optim.SGD(model.parameters(), lr=1e-6)
optimizer
```
![image](https://github.com/Suyeon-j/study_oml/assets/66247203/3673524f-5ec8-43b2-abee-05368a180674)

```
# https://open-metric-learning.readthedocs.io/en/latest/contents/datasets.html#datasetwithlabels
# 01
train_dataset = DatasetWithLabels(df_train, dataset_root=dataset_root)
train_dataset.df
```
![image](https://github.com/Suyeon-j/study_oml/assets/66247203/2d180786-09ff-47c6-ab2e-fb91c476c8dd)


```
# https://open-metric-learning.readthedocs.io/en/latest/contents/losses.html#tripletlosswithminer
# 04
criterion = TripletLossWithMiner(margin=0.1, miner=AllTripletsMiner(), need_logs=True)
criterion
```
TripletLossWithMiner(margin(triplet loss의 마진 설정), miner(triplet을 생성하는데 사용되는 miner를 지정하는 함수), need_logs(로그 기록 여부)): Miner and TripletLoss 조합

```
# https://open-metric-learning.readthedocs.io/en/latest/contents/samplers.html#balancesampler
# 02-01
sampler = BalanceSampler(train_dataset.get_labels(), n_labels=2, n_instances=2)
print(sampler.lbl2idx)
print(sampler.batch_size)
```
![image](https://github.com/Suyeon-j/study_oml/assets/66247203/5ebb9660-9554-41f3-b92c-daeac3529851)

BalanceSampler(labels, n_labels, n_instances): n_instances x n_labels 형태 배치 생성

```
# https://pytorch.org/docs/stable/data.html#torch.utils.data.DataLoader
# 02-02
train_loader = torch.utils.data.DataLoader(train_dataset, batch_sampler=sampler)
train_loader
```
DataLoader(): 데이터셋을 읽어와서 배치단위로 데이터 불러옴

```
for batch in tqdm(train_loader):
    embeddings = model(batch["input_tensors"])
    loss = criterion(embeddings, batch["labels"])
    loss.backward()
    optimizer.step()
    optimizer.zero_grad()

    # info for logging: positive/negative distances, number of active triplets
    print(criterion.last_logs)
```
![image](https://github.com/Suyeon-j/study_oml/assets/66247203/7eebc98d-c611-4df7-809d-5919425ad760)

active_tri: 활성화된 Triplets(Triplet Loss 함수에서 실제로 모델이 학습하고 있는 경우)의 비율을 나타내는 지표

높을수록 유효한 정보를 뽑아냈다고 할 수 있음
